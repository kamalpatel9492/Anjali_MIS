@model AnjaliMIS.Models.DIA_Jangad
@{
    ViewBag.Title = "CreateNew";
}
<script src="~/Scripts/jquery-3.3.1.min.js"></script>

@using (Html.BeginForm())
{
    @*<h2>CreateNew</h2>*@
    <div class="col-md-12">
        <div class="portlet box blue">
            <div class="portlet-title">
                <div class="caption">
                    <i class="fa fa-gift"></i>Jangad Fresh
                </div>
            </div>
            <div class="portlet-body form">
                <div class="form-horizontal">
                    <div class="form-body">
                        @Html.ValidationSummary(false, "", new { @class = "text-danger" })
                        @*<div class="form-group">
                                @Html.LabelFor(model => model.CompanyID, "Jangad", htmlAttributes: new { @class = "control-label col-md-2" })
                                <div class="col-md-10">
                                    @Html.DropDownList("JangadID", null, htmlAttributes: new { @class = "form-control" })
                                    @Html.ValidationMessageFor(model => model.CompanyID, "", new { @class = "text-danger" })
                                </div>
                            </div>*@

                        <div class="form-group">
                            @Html.LabelFor(model => model.PartyID, "Party", htmlAttributes: new { @class = "control-label col-md-2" })
                            <div class="col-md-10">
                                @Html.DropDownList("PartyID", null, htmlAttributes: new { @class = "form-control" })
                                @Html.ValidationMessageFor(model => model.PartyID, "", new { @class = "text-danger" })
                            </div>
                        </div>

                        <div class="form-group">
                            @Html.LabelFor(model => model.Weight, htmlAttributes: new { @class = "control-label col-md-2" })
                            <div class="col-md-4">
                                @Html.EditorFor(model => model.Weight, new { htmlAttributes = new { @class = "form-control" } })
                                @Html.ValidationMessageFor(model => model.Weight, "", new { @class = "text-danger" })
                            </div>

                            @Html.LabelFor(model => model.Quantity, "Than", htmlAttributes: new { @class = "control-label col-md-2" })
                            <div class="col-md-4">
                                @Html.EditorFor(model => model.Quantity, new { htmlAttributes = new { @class = "form-control allownumericwithoutdecimal" } })
                                @Html.ValidationMessageFor(model => model.Quantity, "", new { @class = "text-danger" })
                            </div>

                        </div>

                        <div class="form-group">
                            @Html.LabelFor(model => model.IsLocal, "Is Local ?", htmlAttributes: new { @class = "control-label col-md-2" })
                            <div class="col-md-4 radio-list">
                                <label class="radio-inline">
                                    <input type="radio" name="isLocal" value="True">Yes
                                </label>
                                <label class="radio-inline">
                                    <input type="radio" name="isLocal" value="False">No
                                </label>
                            </div>
                            @Html.LabelFor(model => model.Remarks, htmlAttributes: new { @class = "control-label col-md-2" })
                            <div class="col-md-4">
                                @Html.EditorFor(model => model.Remarks, new { htmlAttributes = new { @class = "form-control" } })
                                @Html.ValidationMessageFor(model => model.Remarks, "", new { @class = "text-danger" })
                            </div>
                        </div>

                        <div id="divCGST" class="form-group" hidden>
                            @Html.LabelFor(model => model.CGST, "CGST", htmlAttributes: new { @class = "control-label col-md-2" })
                            <div class="col-md-4">
                                <select id="ddlCGST" class="form-control"></select>
                            </div>
                            @Html.LabelFor(model => model.SGST, "SGST", htmlAttributes: new { @class = "control-label col-md-2" })
                            <div class="col-md-4">
                                @*<select id="ddlSGST" class="form-control"></select>*@
                                <input id="txtSGSTValue" type="text" class="form-control" readonly="readonly" />
                            </div>
                        </div>

                        <div class="form-group" id="divIGST" hidden>
                            @Html.LabelFor(model => model.IGST, "IGST", htmlAttributes: new { @class = "control-label col-md-2" })
                            <div class="col-md-4">
                                <select id="ddlIGST" class="form-control"></select>
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="control-label col-md-2"></label>
                            <div class="col-md-4 radio-list">
                                <label class="radio-inline">
                                    <input type="radio" name="isJangadType" value="True">Is Rate Per Than?
                                </label>
                                <label class="radio-inline">
                                    <input type="radio" name="isJangadType" value="False">Is Rate Per Carat?
                                </label>
                            </div>
                        </div>

                        <div class="form-group">
                            @Html.LabelFor(model => model.Rate, "Rate", htmlAttributes: new { @class = "control-label col-md-2" })
                            <div class="col-md-4">
                                <input id="txtRate" type="text" class="form-control" />
                            </div>
                        </div>

                        <h3 class="form-section">Jangad Items</h3>
                        <div class="form-group">
                            <label class="control-label col-md-2">Dia</label>
                            <div class="col-md-2">
                                <input id="txtDia" type="text" class="form-control allownumericwithoutdecimal" />
                            </div>
                            <label class="control-label col-md-2">RWeight</label>
                            <div class="col-md-2">
                                <input id="txtRWeight" type="text" class="form-control allownumericwithdecimal" />
                            </div>
                            <label class="control-label col-md-2">PWeight</label>
                            <div class="col-md-2">
                                <input id="txtPWeight" type="text" class="form-control allownumericwithoutdecimal" />
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="control-label col-md-2">PavalionAngle</label>
                            <div class="col-md-2">
                                <input id="txtPavalionAngle" type="text" class="form-control allownumericwithoutdecimal" />
                            </div>

                            <label class="control-label col-md-2">CrownAngle</label>
                            <div class="col-md-2">
                                <input id="txtCrownAngle" type="text" class="form-control allownumericwithoutdecimal" />
                            </div>
                            <label class="control-label col-md-2">CrownHeight</label>
                            <div class="col-md-2">
                                <input id="txtCrownHeight" type="text" class="form-control allownumericwithdecimal" />
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="control-label col-md-2">Girdle</label>
                            <div class="col-md-2">
                                <input id="txtGirdle" type="text" class="form-control allownumericwithoutdecimal" />
                            </div>
                            <label class="control-label col-md-2">Culet</label>
                            <div class="col-md-2">
                                <input id="txtCulet" type="text" class="form-control allownumericwithoutdecimal" />
                            </div>
                            <label class="control-label col-md-2">ji_table</label>
                            <div class="col-md-2">
                                <input id="txtji_table" type="text" class="form-control allownumericwithdecimal" />
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="control-label col-md-2"></label>
                            <div class="col-md-5">
                                <a href="#" class="button bu-block btn default glyphicon glyphicon-plus add-row"> Add Item</a>
                            </div>
                            <div class="col-md-5">
                                <input type="file" class="upload" name="UploadedFile" id="fileLoadDoc" multiple="multiple" />
                            </div>
                        </div>

                        <div id="divJangadList" class="form-group" hidden>
                            <label class="control-label col-md-2">Jangad List</label>
                            <div class="col-md-10">
                                <table class="table table-bordered table-responsive" id="selected_units">
                                    <thead>
                                        <tr>
                                            <th>Select</th>
                                            <th class="text-right">Dia</th>
                                            <th class="text-right">RWeight</th>
                                            <th class="text-right">PWeight</th>
                                            <th class="text-right">PavalionAngle</th>
                                            <th class="text-right">CrownAngle</th>
                                            <th class="text-right">CrownHeight</th>
                                            <th class="text-right">Girdle</th>
                                            <th class="text-right">Culet</th>
                                            <th class="text-right">ji_table</th>

                                        </tr>
                                    </thead>
                                    <tbody class="list">
                                        <tr>
                                            <td colspan="9" class="text-right">Rate (<span id="tdValues"></span>)</td>
                                            <td colspan="9" id="tdItemTotal" class="text-right"></td>
                                        </tr>
                                        <tr>
                                            <td colspan="9" class="text-right">SGST <span id="tdSpanPercentageSGSTValue"></span></td>
                                            <td colspan="9" id="tdSGST" class="text-right"></td>
                                        </tr>
                                        <tr>
                                            <td colspan="9" class="text-right">CGST <span id="tdSpanPercentageCGSTValue"></span></td>
                                            <td colspan="9" id="tdCGST" class="text-right"></td>
                                        </tr>
                                        <tr>
                                            <td colspan="9" class="text-right">IGST <span id="tdSpanPercentageIGSTValue"></span></td>
                                            <td colspan="9" id="tdIGST" class="text-right"></td>
                                        </tr>
                                        <tr>
                                            <td colspan="9" class="text-right">Total</td>
                                            <td colspan="9" id="tdTotal" class="text-right"></td>
                                        </tr>
                                        <tr>
                                            <td colspan="9" class="text-right bold">Final Total</td>
                                            <td colspan="9" id="tdFinalTotal" class="text-right bold"></td>
                                        </tr>
                                    </tbody>
                                </table>
                                <button type="button" style="float:right;" class="delete-row">Delete Item</button>
                            </div>
                        </div>

                    </div>
                    <div class="form-actions">
                        <div class="row">
                            <div class="col-md-offset-3 col-md-9">
                                <input type="button" id="btnSave" value="Save" class="btn green" />
                                @Html.ActionLink("Back to List", "index", "DIA_JangadItem", new { @class = "btn default" })
                            </div>
                        </div>
                    </div>

                </div>
                <!-- END FORM-->
            </div>
        </div>
        <!-- END VALIDATION STATES-->
    </div>
}

<script>
    var itemWiseEachStepAddTotalAmount = 0;
    var jangadList = [];
    var CGSTID = 0;
    var IGSTID = 0;
    var SGSTID = 0;
    var i = 0;
    @if (Model.IsLocal == true) {
        @: $('input:radio[name="isLocal"][value="True"]').attr('checked', true);
               }
   else {
       @: $('input:radio[name="isLocal"][value="False"]').attr('checked', true);
                   }

    @if (Model.IsRatePerCarat == true) {
        @: $('input:radio[name="isJangadType"][value="True"]').attr('checked', true);
             }
    @if (Model.IsRatePerThan == true)
     {
         @: $('input:radio[name="isJangadType"][value="False"]').attr('checked', true);
             }
    $(document).ready(function () {
        RetrieveCGST();
        RetrieveIGST();

        $('input:radio[name=isLocal]').change(function () {
            CheckIsLocal();
        });
        $('input:radio[name=isJangadType]').change(function () {
            CheckJangadType();
        });

        CheckIsLocal();
        CheckJangadType();
        $("#btnSave").click(function () {

            var response = true;
            //response = ValidationRemarks(false);
            if (response == false) {
                alert('Please fill all the compulsory field(s).');
                return false;
            }
            else {
                SaveJangadList();
            }
        });

        $("#ddlCGST").change(function () {

            var changeSGSTValueDependOnCGST = $("option:selected", "#ddlCGST").attr("data-id");
            $("#txtSGSTValue").val("SGST-" + changeSGSTValueDependOnCGST);
            $('#ddlCGST option[data-id="' + changeSGSTValueDependOnCGST + '"]').prop('selected', true);
            FinalCalculation();
        });

        $(".add-row").click(function () {
            i++;
            $('#divJangadList').show();


            var Dia = $('#txtDia').val();
            var RWeight = $('#txtRWeight').val();
            var PWeight = $('#txtPWeight').val();
            var PavalionAngle = $('#txtPavalionAngle').val();
            var CrownAngle = $('#txtCrownAngle').val();
            var CrownHeight = $('#txtCrownHeight').val();
            var Girdle = $('#txtGirdle').val();
            var Culet = $('#txtCulet').val();
            var ji_table = $('#txtji_table').val();

            jangadList.push({
                tablerowid:i,
                Dia: Dia,
                RWeight: RWeight,
                PWeight: PWeight,
                PavalionAngle: PavalionAngle,
                CrownAngle: CrownAngle,
                CrownHeight: CrownHeight,
                Girdle: Girdle,
                Culet: Culet,
                ji_table: ji_table,
            });


            var markup = "<tr>";
            markup += "<td><input type='checkbox' name='record' id='" + i + "'></td>";
            markup += "<td>" + Dia + "</td>";
            markup += "<td class='text-right'>" + RWeight + "</td>";
            markup += "<td class='text-right'>" + PWeight + "</td>";
            markup += "<td class='text-right'>" + PavalionAngle + "</td>";
            markup += "<td class='text-right'>" + CrownAngle + "</td>";
            markup += "<td class='text-right'>" + CrownHeight + "</td>";
            markup += "<td class='text-right'>" + Girdle + "</td>";
            markup += "<td class='text-right'>" + Culet + "</td>";
            markup += "<td class='text-right'>" + ji_table + "</td>";
            markup += "</tr>";

            $("table .list").prepend(markup);
        });



        $(".delete-row").click(function () {
            debugger;
            $("table tbody").find('input[name="record"]').each(function () {
                if ($(this).is(":checked")) {
                    debugger;
                    var checkId = this.id;
                    $(this).parents("tr").remove();

                    $.each(jangadList, function (key, value) {
                        debugger;
                        //var checkitemid = value.ItemID;
                        //var deductquantity = value.OrderedQuantity;
                        //var deductpriceperunit = value.PuchasePrice;
                        if (checkId == value.tablerowid) {

                        //    //productList.pop(key);
                            jangadList.splice(key, 1);
                        //    itemWiseEachStepAddTotalAmount = itemWiseEachStepAddTotalAmount - (deductquantity * deductpriceperunit);
                        //    $('#tdItemTotal').html(itemWiseEachStepAddTotalAmount);
                            FinalCalculation();
                        //    return false;
                        }

                    });
                }
            });

        });
    });


    function SaveJangadList() {

        if (jangadList.length == 0) {
            alert("please jangad item");
            return false;
        }

        var qTYByThan = 0;
        var quantity = 0;
        var Rate = 0;
        var txtPricePerCarat = 0;

        var isRatePerThan = false;
        if ($('input[name=isJangadType]:checked').val() == "True") {
            isRatePerThan = true;
            //qTYByThan = $('#txtQTYByThan').val();
            Rate = $('#txtRate').val();
        }

        var isRatePerCarat = false;
        if ($('input[name=isJangadType]:checked').val() == "False") {
            isRatePerCarat = true;
            Quantity = $('#Quantity').val();
            //txtPricePerCarat = $('#txtPricePerCarat').val();
        }

        var newData = {
            PartyID: $('#PartyID').val(),
            Weight: $('#Weight').val(),
            Remarks: $('#Remarks').val(),
            CGST: $('#ddlCGST').val(),
            CGSTAmount: $('#tdCGST').html(),
            SGST: $('#ddlCGST').val(),
            SGSTAmount: $('#tdSGST').html(),
            IGST: $('#ddlIGST').val(),
            IGSTAmount: $('#tdIGST').html(),
            IsLocal: $('input[name=isLocal]:checked').val(),
            IsActive: $('#IsActive').val(),
            QTYByThan: qTYByThan,
            Quantity: Quantity,
            Rate: Rate,
            PricePerCarat: Rate,
            IsRatePerThan: isRatePerThan,
            IsRatePerCarat: isRatePerCarat,
            DIA_JangadItems: jangadList
        };
        debugger;
        $.ajax({
            url: '@Url.Action("AddJangad", "DIA_JangadItem")',
            data: JSON.stringify(newData),
            type: "POST",
            contentType: "application/json;charset=utf-8",
            dataType: "json",
            success: function (result) {

                $('#InvoiceMessage').modal('show');

                window.location.href = '@Url.Action("CreateNew", "DIA_JangadItem")';
            },
            error: function (errormessage) {

            }
        });
    }




    function CheckIsLocal() {
        if ($('input[name=isLocal]:checked').val() == "True") {
            //$('#divSGST').show();
            $('#divCGST').show();
            $('#divIGST').hide();
            $('#ddlIGST').val("0");
        }
        else if ($('input[name=isLocal]:checked').val() == "False") {
            $('#divCGST').hide();
            //$('#divSGST').hide();
            $('#divIGST').show();
            $('#ddlCGST').val("0");
            $('#ddlSGST').val("0");
        }
        else {
            $('#divCGST').hide();
            //$('#divSGST').hide();
            $('#divIGST').hide();
        }
    }

    function CheckJangadType() {
        if ($('input[name=isJangadType]:checked').val() == "True") {
            debugger;
            var Quantity = $('#Quantity').val();
            var Rate = $('#txtRate').val();
            
            $('#tdValues').html(Rate + " * " + Quantity);

            itemWiseEachStepAddTotalAmount = Rate * Quantity;
            $('#tdItemTotal').html(parseFloat(itemWiseEachStepAddTotalAmount));



            FinalCalculation();
        }
        else if ($('input[name=isJangadType]:checked').val() == "False") {
            debugger;

            var Weight = $('#Weight').val();
            var Rate = $('#txtRate').val();

            $('#tdValues').html(Rate + " * " + Weight);
            itemWiseEachStepAddTotalAmount = Rate * Weight;
            FinalCalculation();
        }
        else {
            //$('#divThan').hide();
            //$('#divCarat').hide();
        }
    }
    //Retrive CGST
    function RetrieveCGST() {
        $.ajax({
            url: '@Url.Action("RetrieveCGST", "INV_Invoice")',
            type: "GET",
            contentType: "application/json;charset=UTF-8",
            dataType: "json",
            success: (function (result) {

                if (result.length > 0) {

                    $("#ddlCGST").empty();
                    $("#ddlCGST").append('<option value="0" data-id="0">Select CGST</option>');
                    for (var i = 0; i < result.length; i++) {
                        var option = $("<option/>");
                        option.attr("value", result[i].TaxID).text(result[i].Tax).attr("data-id", result[i].Percentage);
                        $("#ddlCGST").append(option);
                    }
                    if (CGSTID > 0) {
                        $('#ddlCGST').val(CGSTID);
                        $('#txtSGSTValue').val("SGST-" + $("option:selected", "#ddlCGST").attr("data-id"));
                    }
                    else {
                        $('#ddlCGST').val(0);
                        $('#txtSGSTValue').val(0);
                    }
                    FinalCalculation();

                }
            }),
            error: function (errormessage) {
                alert(errormessage.responseText);
            }
        });
    }

    //Retrive IGST
    function RetrieveIGST() {
        $.ajax({
            url: '@Url.Action("RetrieveIGST", "INV_Invoice")',
            type: "GET",
            contentType: "application/json;charset=UTF-8",
            dataType: "json",
            success: (function (result) {

                if (result.length > 0) {

                    $("#ddlIGST").empty();
                    $("#ddlIGST").append('<option value="0" data-id="0">Select IGST</option>');
                    for (var i = 0; i < result.length; i++) {
                        var option = $("<option/>");
                        option.attr("value", result[i].TaxID).text(result[i].Tax).attr("data-id", result[i].Percentage);
                        $("#ddlIGST").append(option);
                    }
                    if (IGSTID > 0)
                        $('#ddlIGST').val(IGSTID);
                    else
                        $('#ddlIGST').val(0);

                    FinalCalculation();

                }
            }),
            error: function (errormessage) {
                alert(errormessage.responseText);
            }
        });
    }
    FinalCalculation();
    function FinalCalculation() {
        var igstCalculation = 0;
        var cgstCalculation = 0;
        var sgstCalculation = 0;

        var Quantity = $('#Quantity').val();
        var Rate = $('#txtRate').val();
        var Weight = $('#Weight').val();

      

        var igstpercentage = $("#ddlIGST option:selected").attr("data-id");
        igstCalculation = parseFloat(itemWiseEachStepAddTotalAmount * igstpercentage / 100).toFixed(2);
        if (igstCalculation > 0)
            $('#tdIGST').html(igstCalculation);
        else
            $('#tdIGST').html(0);
        if (igstpercentage > 0)
            $('#tdSpanPercentageIGSTValue').html("(" + igstpercentage + "%)");
        else
            $('#tdSpanPercentageIGSTValue').html("(" + 0 + "%)");

        var cgstpercentage = $("#ddlCGST option:selected").attr("data-id");
        cgstCalculation = parseFloat(itemWiseEachStepAddTotalAmount * cgstpercentage / 100).toFixed(2);
        if (cgstCalculation > 0)
            $('#tdCGST').html(cgstCalculation);
        else
            $('#tdCGST').html(0);
        if (cgstpercentage > 0)
            $('#tdSpanPercentageCGSTValue').html("(" + cgstpercentage + "%)");
        else
            $('#tdSpanPercentageCGSTValue').html("(" + 0 + "%)");

        var sgstpercentage = $("#ddlCGST option:selected").attr("data-id");
        sgstCalculation = parseFloat(itemWiseEachStepAddTotalAmount * sgstpercentage / 100).toFixed(2);
        if (sgstCalculation > 0)
            $('#tdSGST').html(sgstCalculation);
        else
            $('#tdSGST').html(0);
        if (sgstpercentage > 0)
            $('#tdSpanPercentageSGSTValue').html("(" + sgstpercentage + "%)");
        else
            $('#tdSpanPercentageSGSTValue').html("(" + 0 + "%)");

        var finaltotal = parseFloat(itemWiseEachStepAddTotalAmount) + parseFloat(igstCalculation) + parseFloat(cgstCalculation) + parseFloat(sgstCalculation);
        finaltotal = parseFloat(finaltotal).toFixed(2)
        $('#tdTotal').html(finaltotal);
        $('#tdFinalTotal').html(Math.round(finaltotal, 2));

        //finaltotal=parseInt(parseFloat(finaltotal));
        //$('#tdFinalTotal').html(Math.round(finaltotal,2));
        //var newAmountPending = finaltotal - $('#AmountReceived').val() - $('#Casar').val();
        //$('#AmountPending').val(parseInt(newAmountPending));

        $('#Quantity').val("");
        $('#txtItemPrice').val("");
    }


    $('input[type="file"]').change(function (e) {
        debugger
        var lengthfile = e.target.files.length;

        var filename = e.target.files[0].name;
        var Files = $("#fileLoadDoc").get(0);
        $("#txtfile").val(filename);
        // $("#btnsbmt").trigger("click");
        formdata = new FormData();
        for (var i = 0; i < e.target.files.length; i++) {
            formdata.append(e.target.files[i].name, e.target.files[i]);
        }
        $.ajax({
            url: '@Url.Action("UploadCollectionFile", "DIA_JangadItem")',
            type: "POST",
            datatype: "JSON",
            contentType: false,
            processData: false,
            data: formdata,
            success: function (result) {
                debugger;

                $('#divJangadList').show();

                result.DIA_JangadItems[0].Dia

                for (var i = 0; i < result.DIA_JangadItems.length; i++) {
                    var Dia = result.DIA_JangadItems[i].Dia;
                    var RWeight = result.DIA_JangadItems[i].RWeight;
                    var PWeight = result.DIA_JangadItems[i].PWeight;
                    var PavalionAngle = result.DIA_JangadItems[i].PavalionAngle;
                    var CrownAngle = result.DIA_JangadItems[i].CrownAngle;
                    var CrownHeight = result.DIA_JangadItems[i].CrownHeight;
                    var Girdle = result.DIA_JangadItems[i].Girdle;
                    var Culet = result.DIA_JangadItems[i].Culet;
                    var ji_table = result.DIA_JangadItems[i].ji_table;

                    jangadList.push({
                        tablerowid: i,
                        Dia: Dia,
                        RWeight: RWeight,
                        PWeight: PWeight,
                        PavalionAngle: PavalionAngle,
                        CrownAngle: CrownAngle,
                        CrownHeight: CrownHeight,
                        Girdle: Girdle,
                        Culet: Culet,
                        ji_table: ji_table,
                    });


                    var markup = "<tr>";
                    markup += "<td><input type='checkbox' name='record' id='" + i + "'></td>";
                    markup += "<td>" + Dia + "</td>";
                    markup += "<td class='text-right'>" + RWeight + "</td>";
                    markup += "<td class='text-right'>" + PWeight + "</td>";
                    markup += "<td class='text-right'>" + PavalionAngle + "</td>";
                    markup += "<td class='text-right'>" + CrownAngle + "</td>";
                    markup += "<td class='text-right'>" + CrownHeight + "</td>";
                    markup += "<td class='text-right'>" + Girdle + "</td>";
                    markup += "<td class='text-right'>" + Culet + "</td>";
                    markup += "<td class='text-right'>" + ji_table + "</td>";
                    markup += "</tr>";

                    $("table .list").prepend(markup);
                }
            }

        })
    });
</script>